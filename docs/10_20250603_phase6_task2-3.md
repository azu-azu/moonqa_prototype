🗓️ 2025/06/03 [Tuesday] 17:30

# 🌕 **Phase 6: インテリジェンス強化（PDF版を使い込むことで、構造判断力を高める段階）**

## 🔸 Task 2: 複合フィルター条件への対応

### 🧭 現在の状態（Phase 6, Task 2 進行中）

| 項目          | 状態     | 説明                                                              |
| ----------- | ------ | --------------------------------------------------------------- |
| ✅ フィルター機能強化 | **完了** | `"source"`, `"tag"`, `"date"` による複合条件フィルターが使える構造に進化した           |
| ✅ チャンクの意味付け | **完了** | 各チャンクに `"source"` `"tag"` `"date"` `"page"` の metadata が付与されている |
| ✅ 検索精度制御    | **完了** | `score_threshold` によるフィルタ処理があり、意味の近いチャンクのみを対象にできる               |
| ✅ メタデータ管理   | **完了** | `pdf_meta.json` により、PDFごとの意味付けを外部ファイルで一元管理できるようになった             |
| ✅ コード構成整理   | **完了** | `filters.py` にフィルター処理を切り出し、`qa.py` はシンプルな構造に保たれている              |

---

### ✨ 今できるようになったこと

#### ✅ 1. 意味ベースの検索絞り込み

> **たとえば：**
> 「2025年の天文学タグの資料だけで、”月の起源”に関する回答をして」
> という意図に対し…

```python
filter_dict = {
    "tag": "astronomy",
    "date": "2025"
}
```

…という**意味ベースの構造的条件**で、検索結果を絞り込めるようになった。

---

#### ✅ 2. 将来の拡張がやりやすくなった

* ✅ `pdf_meta.json` に書くだけで、PDF追加に対応できる
* ✅ intent分類（次フェーズ）や UIからの選択フィルターにもすぐつなげられる
* ✅ `logger.py` に `page` や `tag` を記録すれば、分析や UI表示もできる

---

#### ✅ 3. moonqa は「構造化された RAGボット」になった

もはやただのPDF検索Botやなくて──

> 📚 **意味を持ったチャンクだけを、意味に沿って抽出して、意味に沿った回答を返す。**
> → このレベルの設計は、「単なるLangChainのサンプル」ではなく、**プロダクション設計に足を踏み入れてる段階**。


# 🎯 Task 3 の目的

> 「この質問って、PDFに関すること？ それとも世間話？ 命令？」
> という **ユーザーの入力の“意図（Intent）”を分類して、ログに記録する**こと。

分類例：

| 入力              | intent         |
| --------------- | -------------- |
| 「月ってどうやってできたの？」 | `pdf_question` |
| 「最近疲れてるねん」      | `chitchat`     |
| 「このPDF消して」      | `command`      |

---

## 🔸 Step 1: `classifier.py` の新設
→ 質問を見て `pdf_question` / `chitchat` / `command` を返す関数を定義（ルールベース）

## 🔸 Step 2: `qa.py` にて intent分類を実行
→ `get_answer()` の冒頭で intent を取得して、ログにも反映

## 🔸 Step 3: `logger.py` にて intent をログ出力する
→ `"intent": "pdf_question"` などを `qa_log.jsonl` に含める

---

### ✅ 実行結果

| 項目           | 内容                                 |
| ------------ | ---------------------------------- |
| ✅ `question` | `"月って、どうやってできたの？"` → 意図分類対象として十分   |
| ✅ `intent`   | `"pdf_question"` → ちゃんと判定できてる |
| ✅ `status`   | `"success"` → 回答も出せてる              |
| ✅ `results`  | しきい値を満たす複数チャンクがヒット                 |
| ✅ `answer`   | 関西弁で、構造的に整った要約＋出典つき回答            |

---

### 🔸 Task 3: intent分類（PDF質問／雑談／命令）

| 項目                                  | ステータス  | 説明                                                   |
| ----------------------------------- | ------ | ---------------------------------------------------- |
| ✅ rule-based分類で、質問をタイプ分類            | **完了** | `classifier.py` にて `classify_intent()` 実装済み          |
| ✅ `classifier.py` を新設し、単語出現などでラフに分類 | **完了** | `"疲れた"`, `"消して"` などのキーワードで分類動作OK                     |
| ✅ ログにも分類結果を記録                       | **完了** | `qa_log.jsonl` に `"intent": "pdf_question"` など出力確認済み |

---

### 🎉 結論：

> **moonqaは、質問の意味を“分類”し、構造的にログ記録できるようになった。**
