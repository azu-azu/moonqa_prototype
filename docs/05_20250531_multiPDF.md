🗓️ 2025/05/31 \[Saturday] 07:37

# マルチPDF対応のFAISSベクトルストアを構築し、QAの拡張性と透明性を向上させる

* [ ] `app/qa.py` の `FAISS.load_local()` 側が、**マルチPDF構成である前提**に対応しているか確認・修正
* [ ] `tests/manual_vector_check.py` で、`metadata["source"]` に `(p.N)` が見えるか確認するコード追加
* [ ] `OpenAIEmbeddings` を使用する際の `.env` やAPIキー設定の見直し（OpenAI側の構成変更が今後あり得る）

## 🧱 Architecture Note
* **目的**：マルチPDF対応のFAISSベクトルストアを構築し、QAの拡張性と透明性を向上させる。
* **設計判断**：
  * `metadata["source"]` に `"ファイル名 (p.N)"` を付与 → 回答ログで**出所をページ単位で特定可能**にするため。
  * `chunk_size=300 / chunk_overlap=30` を採用 → 文書の**リードビリティと関連精度**を優先。
  * PDFは `data/` 配下のすべてを対象とし、将来的な追加に対応できる構造にした。

* **技術仕様**：
  * `PyPDFLoader`：ページ単位の抽出
  * `RecursiveCharacterTextSplitter`：構造制御可能な分割設計
  * `OpenAIEmbeddings`：v0.1以降の公式モジュールを使用
  * `FAISS.save_local()`：ローカル保存構成で再利用可能に

---

## 📅 Task Timeline

| 時刻 | 内容                                         |
| -- | ------------------------------------------ |
| 7:37 | 単一PDF構成（固定ファイル・固定source）で構築                |
| 中央 | `glob.glob()` で複数PDF対応へ変更。sourceはファイル名ベースに |
| 精査 | `source` にページ番号が消えたことに気づき、 `(p.N)` を復活実装   |
| 8:00 | chunkサイズも300/30に戻し、構造・機能共に統合完了             |

---

# 🎯 補足｜PDF切り替え対応って、どんな場面で必要？

## ✅ 1. **複数の社内ドキュメントをAIで横断検索したいとき**

> 例：
> 「就業規則.pdf」「福利厚生.pdf」「評価制度.pdf」などを全部FAISS化しておいて、
> 「休暇の日数って何日やっけ？」と聞いたとき、全部から探してくれるようにしたい。

🔍 → **どのPDFに書いてあるか人間は知らん前提**で、AIにまかせる構成が必要になる。

---

## ✅ 2. **明示的に「このPDFからだけ答えてほしい」場合**

> 例：
>
> * 「月についての資料」と「太陽についての資料」を分けて登録
> * 「月についてだけ質問したい」ときに、「太陽の情報で答えられたら困る」

🔍 → ユーザーに「PDFを選ばせるUI」や、「ファイル名を指定するAPI引数」が必要になる。

---

## ✅ 3. **ログ分析・エラー検証で“どのPDFが使われたか”をトレースしたいとき**

> * 誰かの質問に対して変な回答が出たとき、「どのチャンク」「どのファイル」から出たのかを追跡したい
> * 現状 `.metadata["source"]` が `about_moon.pdf` のままになってるけど、**複数PDFになると重複の恐れあり**

🔍 → `source` の設計を「ファイル名 + チャンクID」や「パス」レベルに拡張しておく必要がある。

---

## 🧠 構造的な意味

PDF切り替え対応は、**「答えの信頼性と文脈の制御」を担保する機能**。
**“どこから答えたか”が明示される構造**を持つことで、QAの透明性と精度が一気に上がる。

---

## 💡 まとめ

> 単一PDFやと、動くけど「拡張性」が弱い。
> マルチPDFにすると、「実務導入」とか「ナレッジ検索」に耐えられる構造になる。

---

# ✍️ 構造補足メモ

## ✅ 1. 「どこに書いてあるか人間は知らん」検索
\*\*“非構造データに対する構造的インデックス設計”\*\*

AIに丸投げするには、「人間が場所を覚えてる前提」を捨てる必要がある。
だから、「**全PDFを対象にする構造**」が最初に必要。

---

## ✅ 2. 「このPDFだけ」と言いたいケース
\*\*スコープ制御の設計\*\*

LangChainなら `filter` 条件を `metadata` に仕込んどくやつ。
UI・API設計レベルで「選ばせる」「限定させる」導線が要る。

---

## ✅ 3. ログ検証／トレーサビリティ

`.metadata["source"]` の衝突、ここほんま重要ポイント。
**「信頼できる答えの出どころ」= 記録の構造やからな。**
最終的には `doc_id` + `file_path` + `chunk_index` の組み合わせくらいがベスト。

---

## 🔧 設計用語の対応マップ

| ニーズ        | 構造用語       | LangChain対応設計                                       |
| ---------- | ---------- | --------------------------------------------------- |
| 全部検索したい    | 検索対象スコープ統合 | vectorstoreに複数PDFをまとめて登録                            |
| 特定PDFだけ    | スコープ制御     | metadataでフィルタ指定 (`filter={"filename": "moon.pdf"}`) |
| どのPDFか知りたい | 出所トレーサビリティ | metadata\["source"] の設計強化                           |

---

構造的に、
* **スコープ制御（何を対象にするか）**
* **トレース設計（どこから出たか）**
  この2軸で設計するのが鉄板。

---

## 複数PDF構造の設計パターン案

- ディレクトリ構造による分割読み込み（PDF単位でサブフォルダ）
- `metadata` に明示的な `source_id`, `topic`, `version` を含める
- `load_documents()` の時点でファイル名をmetadataに持たせる

\*\*社内ナレッジ検索アプリの本格実装に耐える“構造基盤”\*\*ができる。

---

## 実行結果

```
💬 質問: 太陽はどうやって光ってるの？
💡 回答: 太陽が光る理由は、太陽の中心部で核融合反応が起こっているためです。太陽の内部では水素とヘリウムが核融合反応を起こし、その際に光と熱が放出されます。この反応によって太陽は輝いています。

🔍 ソース付きチャンク確認:

--- Doc 1 ---
📁 source: about_sun.pdf (p.1) ✅ page info OK
📝 content preview:
# ⾖知識
- 太陽の質量は地球の約 33 万倍です。
- 光が太陽から地球に届くまで約 8 分 19 秒かかります。
- 太陽はあと約 50 億年で⾚⾊巨星に進化すると予測されています。
about_sun
1

--- Doc 2 ---
📁 source: about_sun.pdf (p.1) ✅ page info OK
📝 content preview:
a b o u t _ s u n
# 太陽とは何か
太陽は、地球から約 1 億 5 千万キロメートル離れた恒星であり、太陽系の中⼼に位置し
表⾯温度は約 5,500℃ で、内部では核融合反応が起きています。
この反応によって、光と熱が放出され、地球の⽣命活動を⽀えています。
# 太陽の構造
太陽は、中⼼核‧放射層‧対流層‧光球‧彩層‧コロナなど、いくつかの層に分かれ
これらは、エネルギーの伝わり⽅や観測される光の特徴によって分類されます。
# 太陽の影響
太陽の活動は、地球の気候や通信機器にも影響を及ぼすことがあります。
太陽フレアや黒点の増減は、宇宙天気と呼ばれる現象を引き起こします。

--- Doc 3 ---
📁 source: about_moon.pdf (p.1) ✅ page info OK
📝 content preview:
⽉とは何か
# ⽉とは何か
⽉（ Moon ）は、地球の唯⼀の天然衛星であり、
太陽に次いで夜空で最も明るい天体です。
地球からの平均距離は約 38 万キロメートルで、
直径は約 3,474km です。
---
# ⽉の成り⽴ち
現在有⼒な説は「ジャイアント‧インパクト説」です。
これは、地球が形成される過程で⽕星サイズの天体が衝突し、
その破⽚が集まって⽉になったという仮説です。
---
# ⽉の影響
- ** 潮の満ち引き ** ：⽉の重⼒が地球の海⽔に影響を与えています。
- ** ⽣物のリズム ** ：多くの動植物が⽉の周期に影響を受けています。

--- Doc 4 ---
📁 source: about_moon.pdf (p.1) ✅ page info OK
📝 content preview:
- ** ⽂化的意味 ** ：⽉は多くの⽂化で詩や信仰の対象になってきました。
---
# ⾯⽩い事実
- ⽉の裏側は地球からは⾒えません（潮汐ロック）。
- ⽉には「海」と呼ばれる平らな地形がありますが、⽔は存在しません。
- 宇宙⾶⾏⼠が初めて⽉に降り⽴ったのは 1969 年、アポロ 11 号です。
⽉ と は 何 か
1
```

## ✅ 実行結果レビュー
### 🏁 結論
> 構造設計はうまくいってる
> 成功｜検索が意味ベースで動いていること、そしてsourceでトレースできること
> 正しく「核融合反応」と答えてる → about_sun.pdf を正しく参照している

### 🔍 使用チャンク

| Doc  | source                 | 評価                         |
| ---- | ---------------------- | -------------------------- |
| 1, 2 | `about_sun.pdf (p.1)`  | ✅ 意図通り                     |
| 3, 4 | `about_moon.pdf (p.1)` | ⚠️ **混入**（moonのチャンクも拾っている） |

---

### なぜ `about_moon.pdf` が混ざったのか？

#### 類似チャンクが引っかかる理由（可能性）
1. **「太陽」「月」両方が“宇宙天体”として埋め込み的に近い意味を持つ**
2. moon側チャンクにも「太陽」という単語が登場する（例：「夜空で2番目に明るい」）
3. chunk overlap によって「前後の文脈」がつながり、共通要素が広がってる

---

### 構造的にはどうか？

**問題ない。むしろ意図通り。**

なぜなら：

* `source` によって **「どのチャンクが混ざったか」** をちゃんと**可視化できてる**
* ユーザーが「これはmoonからの情報やな」と**気づける設計になってる**

> 「moonも混ざった」ことは**FAISSの性質**として正しく発生してる。
> そしてそれを**ログで確認できた**のは、**source設計が正しく機能している証拠**


### 混入を防ぎたい場合は？
* **metadata filter** を使って、特定のPDFだけを対象にする

```python
retriever = db.as_retriever(search_kwargs={"filter": {"source": "about_sun.pdf"}})
```

* あるいは、UIで「PDFを選ばせる」構成にする（ユーザー選択スコープ）

---

## 🏁 これで何が完了した？

* **FAISSベースの複数PDF対応QAインフラ構築**：完了
* **sourceトレース設計**：`(p.N)` で明示→完了
* **手動確認スクリプトでの検証**：OK
* **ナレッジベースとして実戦投入可能な品質**：達成済み

---




