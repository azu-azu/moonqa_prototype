## 📘 Moon QA: 検索観察モード構築（スコア付きログ基盤）
🗓️ 2025/05/27 \[Tuesday] 17:50-18:05
---

### 🎯 目的（構造判断）

* 単なるQAの成功だけでなく、「**なぜその回答になったか**」を観察可能にする
* 検索構造の壊れ・精度劣化を検知できる**内部可視化層**を作る
* 今後のフィードバック学習・UI設計に活かせるログ形式を整える

---

### 🔧 実施内容（構造変更・追加）

| 内容                                    | 説明                                     |
| ------------------------------------- | -------------------------------------- |
| ✅ `RetrievalQA` を廃止                   | → 中間構造がブラックボックスで観察できないため               |
| ✅ `retriever.invoke()` に移行            | → `.get_relevant_documents()` の廃止準備に対応 |
| ✅ `ChatOpenAI.invoke()` に統一           | → `.predict()` 廃止に向けた設計移行              |
| ✅ `similarity_search_with_score()` 導入 | → ヒット文書のスコアを記録するため                     |
| ✅ `.content` 抽出処理の追加                  | → LLMの返却形式が構造化されたため                    |
| ✅ Markdownログに文書とスコアを記録                | → 分析・観察・共有可能なログ設計に進化                   |

---

### 📂 ファイル変更点

* `app/qa.py`

  * `question_answer_with_scores()` 関数追加・構造化
  * `.invoke()` 対応
  * 類似度スコア付きログ出力処理追加

---

### 📋 pending list（やり残し・次ステップ）

| 項目                | 優先度 | 内容                               |
| ----------------- | --- | -------------------------------- |
| JSON形式ログ出力        | 中   | 検証用・可視化用として併用できると分析向けに便利         |
| スコア閾値の可視化         | 中   | `score_threshold` などを調整できる構造に    |
| UI層との連携           | 低   | logs/qa\_log.md をブラウザで見せる構造へ拡張可能 |
| 評価用質問セットでのRAG精度検証 | 中〜高 | 複数の質問に対してどれだけ妥当な文書が選ばれるか評価       |

---

## 📘 Moon QA: 類似度しきい値制御の導入と構造的検証基盤の完成
🗓️ 2025/05/27 \[Tuesday] 18:15-18:45

### 🧩 構造判断の本質

> **検索スコアに基づく文書制御を加えることで、
> Moon QAは“回答の正確性を構造的に担保できる設計”に進化した。**

---

### 🔧 実施内容（追加点）

| 内容                       | 説明                                     |
| ------------------------ | -------------------------------------- |
| ✅ 類似度スコアによるフィルタ機能追加      | → `score_threshold=0.7` に設定し、低スコア文書を除外 |
| ✅ フィルタ後の文書が0件だった場合の対処追加  | → 空回答での誤作動防止                           |
| ✅ Markdown＋JSONL両方のログに対応 | → UI連携・自動評価のための構造化基盤を形成                |

---

### 🎯 完了の定義：すべて満たした！

* [x] 回答の根拠（文書・スコア）を観察できる
* [x] ログに人間向け・構造化形式の両方を出力
* [x] 精度劣化を防ぐためのスコア制御機構を導入
* [x] future UI / eval に耐えうる構造設計を完了

---

### 📋 pending list（次にやる可能性のあること）

| 項目                        | 優先度 | 内容                     |
| ------------------------- | --- | ---------------------- |
| CLI引数で `--threshold` 指定対応 | 低   | 柔軟な評価用スクリプトに向けて        |
| 回答に使用した `source` をUIに表示   | 中   | エンドユーザーへの説明責任対応        |
| logをHTMLに変換するテンプレート作成     | 中   | Markdown/JSONの見える化に向けて |
| 質問セットを使った自動評価ループ          | 高   | 精度チューニングとretrain準備へ    |

---


## 📘 Moon QA: 設定ファイル分離とグローバル制御の導入
🗓️ 2025/05/27 \[Tuesday] 19:00–20:30

---

### 🎯 目的（構造判断）

* モデル・閾値などの動的パラメータを**グローバルで一元管理**できるようにする
* `qa.py` などから直接ハードコードせずに、**設定変更の影響範囲を最小化**
* 実験・UI連携・CLI拡張など、将来の**構成柔軟性を保証する設計基盤**にする

---

### 🔧 実施内容（構造変更・追加）

| 内容                         | 説明                                                   |
| -------------------------- | ---------------------------------------------------- |
| ✅ `settings.py` 作成         | → `MODEL_NAME`, `THRESHOLD` をここで一元管理                 |
| ✅ `qa.py` のハードコード除去        | → 設定値はすべて `from app.settings import XXX` に変更         |
| ✅ JSONエラー対処（float32→float） | → スコアを `float(score)` で変換して `json.dumps()` を通す       |
| ✅ ログに使った文書情報も含める           | → `source`, `score`, `content` をすべて記録。構造的に観察可能な設計へ進化 |
| ✅ 閾値0.0のテストで動作確認           | → スコア制限なしでも取得できるか実証し、閾値の有効性と影響範囲を把握                  |

---

### 📂 ファイル変更点

* `app/settings.py` 新規作成

  * `THRESHOLD = 0.5`（実験で 0.0 に一時変更）
  * `MODEL_NAME = "gpt-4-0613"`（任意のモデルへ簡単に切り替え可）

* `app/qa.py` 更新

  * `settings` からパラメータ取得に変更
  * `float(score)` 変換処理追加
  * `append_json_log()` の整備・統一化

---

### 📋 pending list（やり残し・次ステップ）

| 項目                               | 優先度 | 内容                                          |
| -------------------------------- | --- | ------------------------------------------- |
| CLIから `--model` `--threshold` 指定 | 中   | 実験・検証を柔軟に行えるように                             |
| 設定ファイルを`.env`に統合                 | 中   | Poetry & dotenvで、環境ごとの切り替えも可能に              |
| 閾値とモデルをUIで選択可能に                  | 中   | フロント連携時に設定変更が即時反映できる構造へ（Web UI設計前提）         |
| 実験パターンに応じたログフォーマット切替             | 低   | dev/debug/productionで記録粒度や形式を調整できると便利（構成設計） |

---

🎯 **構造的まとめ：**

> 「設定のハードコードからの脱却」と「設定値の一元管理」によって、
> Moon QA の構成は“観察・実験・UI対応に向けたモジュラ設計”として整ったで。

---

