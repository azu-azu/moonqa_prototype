🗓️ 2025/06/01 \[Sunday] 16:30

# 🌕 Phase 5 / Task 0: CI構成の設計

## 🌙 Cause Summary

ログと自動テストの整備は完了しており、次に必要なのは「品質を継続的に守るための仕組み＝CI（継続的インテグレーション）」の導入である。
目的：CIで自動テストと品質管理を仕組み化する

---

## 🌙 Possible Causes

* `test_qa_search.py` が `pytest` で正常に動作する状態になっており、CIでの自動化が可能
* `manual_` 系ファイルは全て手動確認用であり、CI対象に含めるべきではない
* `.env` に依存している部分があるため、**ダミー環境変数の定義**がCI実行に必要

---

## 🌙 Action Plan

* [☑️] **`tests/`配下の `test_qa_search.py` のみ**を `pytest` 対象と明示
* [☑️] `manual_*.py` はCI対象から除外（pytestからも無視される構成に）
* [☑️] `.env.example` を作成して、必要なダミー変数を明記（CIでのエラー防止）
* [☑️] `.github/workflows/ci.yml` を新規作成：

  * `ubuntu-latest` で動作
  * `poetry install` → `pytest tests/test_qa_search.py`
* [ ] `logs/qa_log.jsonl` の出力があっても CI は通るように設計

  * （例：`logs/` フォルダを `.gitignore` に追加する）

---

## 🌙 Structural Note

* CI設計の初期段階では、**「壊さない」ことが最重要**。
* 既存の構造（分離されたログ出力、責務が明確なテスト構成）を活かす形で、**最小限のCI構成から始める**のが正解。
* 後から通知やブランチ制御、ログ検証などを拡張できる構造にしておく。

---

## Done（Phase 5 / Task 0）
🗓️ 2025/06/01 \[Sunday] 16:30-16:50

* CI導入の初期設計（GitHub Actionsベース）を完了
* `.github/workflows/ci.yml` を作成して `pytest` 実行の自動化ルートを確保
* `.env.example` を **実際の `.env` に合わせて最小限で作成**

  * `OPENAI_API_KEY`, `OPENAI_MODEL` のみ
* `.pytest.ini` を追加して **`manual_*.py` をpytest対象から除外**
* `logs/` はすでに `.gitignore` 済みで安全確認完了
* すべてのファイルを commit ＆ push 済み（構造記録対応）

---

## 🌱 気づき・改善ポイント

* `.env.example` は「使ってる値だけ」に絞ることで、**他の開発者にも誤解なく伝えられる**
* `pytest.ini` のような「小さい設定ファイル」でも、**構造に及ぼす影響が大きい**と再確認
* CIは「回すこと」ではなく、「何を守りたいかを明示すること」が本質やなと気づけた

---

## 🧭 今の状態

* CIが最小構成で安定して走る状態になった
* `test_qa_search.py` に限定されており、**manualチェックとの住み分けも完了**
* 今後は「CIの出力内容のバリデーション」や「エラー時通知」へ拡張できる土台ができた

---


# 🌕 Phase 5 / Task 1: CI内でのログ出力バリデーション**

---

## 🌙 Cause Summary

CIでは `pytest` が通るようになったが、**実際に出力されるログ（qa\_log.jsonl）が壊れていないか？** を誰も見ていない。
構造ログが分析や可視化の基盤になる以上、**CI上でも構造バリデーションが必要**。

---

## 🌙 Possible Causes

* `qa_log.jsonl` が空／壊れていても、pytestは通る状態
* 人間が tail + jq で見ていた構造チェックが、自動では行われていない
* 今後CIで可視化・分析基盤とつなげるなら、「ログの正しさ」こそ生命線

---

## 🌙 Action Plan

* [ ] `tests/test_qa_search.py` の末尾に、**ログ構造チェック関数**を追加
* 例：最後の1行を読み取り、`timestamp` や `results` が存在するか `assert` で確認
* [ ] 必要なら `log_utils.py` に `validate_log_entry()` 関数を追加して使い回し可能に
* [ ] CI上でも log ファイル構造エラーが出たら、**pytest が fail になるように設計**
* [ ] `qa_log.jsonl` に出力がなければ skip or warning にするなど工夫

---

## 🌙 Structural Note

* これは**ログ出力の“構造的信頼性”を担保するためのCI強化**タスク
* コードが「動く」だけでなく、**構造が“守られている”ことを確認できる**のがCIのあるべき姿
* `tail | jq` に頼る人力チェックから、pytestによる機械チェックへの移行を目指す

---

